{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row my-3">
        <div class="col-1">
            <a href="{{url_for('patient_profile',patient_id='P{0:0=3d}'.format(patient.id-1))}}" class="text-decoration-none"><strong
                    class="h3 text-green font-weight-bolder">&lt;&lt;</strong></a>
        </div>
        <div class="col-10">
            <div class="row">
                <div class="col-md-6 col-lg-3 text-center mt-2">
                    <strong>Updated:&nbsp;</strong><span>{% for d in diags %}{% if loop.first %}{{d.date_loaded}}{% endif %}{% endfor %}</span>
                </div>
                <div class="col-md-6 col-lg-3 text-center mt-2">
                    <strong>Name:&nbsp;</strong><span>{{patient.first_name}}&nbsp;{{patient.last_name}}</span>
                </div>
                <div class="col-md-6 col-lg-3 text-center mt-2">
                    <strong>Patient ID:&nbsp;</strong><span>{{patient_id}}</span>
                </div>
                <div class="col-md-6 col-lg-3 text-center mt-1">
                    <form action="/search">
                        <input type="text" name="search" id="search" placeholder="Search Patient Name / ID" class="form-control">
                    </form>
                </div>
            </div>
        </div>
        <div class="col-1 text-right pl-0">
            <a href="{{url_for('patient_profile',patient_id='P{0:0=3d}'.format(patient.id+1))}}" class="text-decoration-none"><strong
                    class="h3 text-green font-weight-bolder">&gt;&gt;</strong></a>
        </div>
    </div>
</div>
<div class="card text-center">
    <div class="card-header">
        <ul class="nav nav-tabs nav-fill card-header-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <a class="nav-link active font-weight-bold" id="profile-tab" data-toggle="tab" href="#profile" role="tab"
                    aria-controls="profile" aria-selected="false">Patient Profile</a>
            </li>
            <li class="nav-item">
                <a class="nav-link font-weight-bold" id="ctscan-tab" data-toggle="tab" href="#ctscan" role="tab"
                    aria-controls="ctscan" aria-selected="false">CT Scan</a>
            </li>
            <li class="nav-item">
                <a class="nav-link font-weight-bold" id="chest-tab" data-toggle="tab" href="#chest" role="tab"
                    aria-controls="chest" aria-selected="false">Chest X-Ray</a>
            </li>
            <li class="nav-item">
                <a class="nav-link font-weight-bold" id="retinopathy-tab" data-toggle="tab" href="#retinopathy" role="tab"
                    aria-controls="retinopathy" aria-selected="true">Retinopathy</a>
            </li>
        </ul>
    </div>

    <div class="card-body">
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                {% include 'profile.html' %}
            </div>
            <div class="tab-pane fade" id="ctscan" role="tabpanel" aria-labelledby="ctscan-tab">
                {% with diagtype='BreastCancer' %}
                {% include 'diagnosis.html' %}
                {% endwith %}
            </div>
            <div class="tab-pane fade" id="chest" role="tabpanel" aria-labelledby="chest-tab">
                {% with diagtype='ChestX-Ray' %}
                {% include 'diagnosis.html' %}
                {% endwith %}
            </div>
            <div class="tab-pane fade" id="retinopathy" role="tabpanel" aria-labelledby="retinopathy-tab">
                {% with diagtype='RetinaImage' %}
                {% include 'diagnosis.html' %}
                {% endwith %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{{url_for('static',filename='js/gauge.min.js')}}"></script>
<script>
var gauge = []
var gaugeWidth = 200;
    var gaugeHeight = 200;
    var majorTicks = [
        "0",
        "20",
        "40",
        "60",
        "80",
        "100",
    ]
    var highlights = [{
            "from": 0,
            "to": 25,
            "color": "rgba(0,255,0,0.6)"
        },
        {
            "from": 25,
            "to": 50,
            "color": "rgba(255,255,0,0.6)"
        },
        {
            "from": 50,
            "to": 75,
            "color": "rgba(255,165,0,0.6)"
        },
        {
            "from": 75,
            "to": 100,
            "color": "rgba(255,0,0,0.6)"
        }
    ]
    var diag_json =[]
    {% for diagtype in ['BreastCancer','ChestX-Ray','RetinaImage'] %}
    {% for item in diags if item.image_type.value == diagtype %}
        {% if loop.first %}
        diag_json.push(JSON.parse({{item.diag_json|tojson|safe}}));
        for(var i=0;i<Object.keys(diag_json[diag_json.length-1]).length;i++){
            gauge.push(new RadialGauge({
                renderTo: 'gauge'+i+'-{{item.image_type.value}}',
                width: gaugeWidth,
                height: gaugeHeight,
                units: "%",
                value: 100*diag_json[diag_json.length-1][Object.keys(diag_json[diag_json.length-1])[i]],
                minValue: 0,
                valueBox: true,
                maxValue: 100,
                majorTicks: majorTicks,
                minorTicks: 2,
                strokeTicks: true,
                highlights: highlights,
                colorPlate: "#fff",
                borderShadowWidth: 0,
                borders: false,
                needleType: "arrow",
                needleWidth: 3,
                needleCircleSize: 4,
                needleCircleOuter: true,
                needleCircleInner: false,
                animationDuration: 1500,
                animationRule: "linear",
            }).draw());
        }
        {% endif %}
    {% endfor %}
    {% endfor %}
</script>
{% endblock %}
